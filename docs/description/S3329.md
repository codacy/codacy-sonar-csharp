When encrypting data with the Cipher Block Chaining (CBC) mode an Initialization Vector (IV) is used to randomize the encryption, ie under a given key the same plaintext doesn’t always produce the same ciphertext. The IV doesn’t need to be secret but should be unpredictable to avoid "Chosen-Plaintext Attack".
 
To generate Initialization Vectors, NIST recommends to use a secure random number generator.
 
## Noncompliant Code Example

    public void Encrypt(byte[] key, byte[] data, MemoryStream target)
    {
        byte[] initializationVector = new byte[] { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16 };
    
        using var aes = new AesCryptoServiceProvider();
        var encryptor = aes.CreateEncryptor(key, initializationVector); // Noncompliant, hardcoded value is used
    
        using var cryptoStream = new CryptoStream(target, encryptor, CryptoStreamMode.Write);
        cryptoStream.Write(data);
    }

## Compliant Solution

    public byte[] Encrypt(byte[] key, byte[] data, MemoryStream target)
    {
        using var aes = new AesCryptoServiceProvider();
        var encryptor = aes.CreateEncryptor(key, aes.IV); // aes.IV is automatically generated to random secure value
    
        using var cryptoStream = new CryptoStream(target, encryptor, CryptoStreamMode.Write);
        cryptoStream.Write(data);
    
        return aes.IV;
    }

## See
 
- [OWASP Top 10 2021 Category A2](https://owasp.org/Top10/A02_2021-Cryptographic_Failures/) - Cryptographic Failures
- [OWASP Top 10 2017 Category A6](https://www.owasp.org/index.php/Top_10-2017_A6-Security_Misconfiguration) - Security
  Misconfiguration
- [Mobile AppSec
  Verification Standard](https://mobile-security.gitbook.io/masvs/security-requirements/0x08-v3-cryptography_verification_requirements) - Cryptography Requirements
- [OWASP Mobile Top 10 2016 Category M5](https://owasp.org/www-project-mobile-top-10/2016-risks/m5-insufficient-cryptography) -
  Insufficient Cryptography
- [MITRE, CWE-329](https://cwe.mitre.org/data/definitions/329) - Not Using an Unpredictable IV with CBC Mode
- [MITRE, CWE-330](https://cwe.mitre.org/data/definitions/330) - Use of Insufficiently Random Values
- [MITRE, CWE-340](https://cwe.mitre.org/data/definitions/340) - Generation of Predictable Numbers or Identifiers
- [MITRE, CWE-1204](https://cwe.mitre.org/data/definitions/1204) - Generation of Weak Initialization Vector (IV)
- [NIST, SP-800-38A](https://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-38a.pdf) - Recommendation for Block Cipher
  Modes of Operation